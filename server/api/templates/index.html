<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>pyRD</title>
  </head>
  <body>
    <img src="" alt="Dynamic Image" />
  </body>
  <script type="text/javascript">
    const KEY = prompt("Key:");

    const img = document.querySelector("img");
    var filename = "file_session1.png"; // Default filename

    const loop = () => {
      fetch("https://ij53sf8rf6.execute-api.ap-south-1.amazonaws.com/dev", {
        method: "POST",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          httpMethod: "POST",
          path: "/rd",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ _key: KEY, filename: filename }),
          isBase64Encoded: false,
          queryStringParameters: {},
        }),
      })
        .then(function (response) {
          // Check if the response is okay (status code in the range 200-299)
          if (!response.ok) {
            throw new Error(
              "Network response was not ok: " + response.statusText
            );
          }

          // Get the new filename from headers (if your API sends it back in the headers)
          filename = response.headers.get("filename") || filename; // fallback to current filename if not present
          return response.blob();
        })
        .then(function (myBlob) {
          if (myBlob.size) {
            var objectURL = URL.createObjectURL(myBlob);
            img.src = objectURL;
          } else {
            console.log("img not change");
          }
        })
        .catch((err) => console.error("Fetch error:", err));
    };

    // Call the loop function at intervals
    var setIntervalId = window.setInterval(loop, 500);

    // Function to post events
    var postEvent = (payload) => {
      console.log(payload);
      payload._key = KEY;
      // construct an HTTP request
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "./event_post", true);
      xhr.setRequestHeader("Content-Type", "application/json; charset=UTF-8");
      // send the collected data as JSON
      xhr.send(JSON.stringify(payload));
      xhr.onloadend = function () {
        // done
      };
    };

    // Event listeners for image click and keydown
    img.addEventListener("click", (event) => {
      const payload = {
        type: event.type,
        x: event.clientX,
        y: event.clientY,
      };
      postEvent(payload);
    });

    document.onkeydown = (event) => {
      const payload = {
        type: event.type,
        ctrlKey: event.ctrlKey,
        altKey: event.altKey,
        shiftKey: event.shiftKey,
        key: event.key,
      };
      postEvent(payload);
      event.preventDefault();
    };
  </script>
</html>
